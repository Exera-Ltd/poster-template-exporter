<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchPoster Pro - by Exera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script type="module">
        import removeBackground from 'https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.4.5/dist/index.mjs';
        window.removeBackground = removeBackground;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
        }

        .sidebar {
            flex: 0 0 320px;
            background: #f8f9fa;
            padding: 25px;
            border-right: 1px solid #e0e0e0;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .canvas-area {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 300px;
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #555;
            margin-bottom: 6px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: block;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        #canvas-container {
            border: 2px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            background: white;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .template-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .template-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .data-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .data-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .data-row button {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .header-logo {
            transition: opacity 0.3s ease;
        }

        .header-logo.hidden {
            display: none;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            padding: 0 20px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #667eea;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        .bulk-data-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .bulk-data-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .bulk-data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .bulk-data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .bulk-data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .bulk-data-table tr:last-child td {
            border-bottom: none;
        }

        .bulk-data-table input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .bulk-data-table input[type="file"] {
            font-size: 12px;
        }

        .bulk-data-table button {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .sidebar {
                flex: 0 0 100%;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .canvas-area {
                padding: 15px;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .tabs {
                overflow-x: auto;
                padding: 0 10px;
            }

            .tab {
                padding: 12px 20px;
                font-size: 14px;
                white-space: nowrap;
            }

            .bulk-data-table {
                overflow-x: auto;
            }
        }

        .icon {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;">
                <img src="logo1.svg" alt="Exera Logo 1" class="header-logo" id="logo1" style="height: 50px; object-fit: contain;">
                <img src="logo2.svg" alt="Exera Logo 2" class="header-logo" id="logo2" style="height: 50px; object-fit: contain;">
            </div>
            <h1>BatchPoster Pro</h1>
            <p style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Proudly by Exera</p>
            <p>Design once, export hundreds with different data</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('design')">
                üé® Design
            </button>
            <button class="tab" onclick="switchTab('bulk')" id="bulk-tab">
                üì¶ Bulk Export
                <span class="tab-badge" id="template-count">0</span>
            </button>
        </div>

        <div class="main-content">
            <!-- Design Tab -->
            <div id="design-tab" class="tab-content active" style="display: flex; flex-wrap: wrap; width: 100%;">
                <div class="sidebar">
                    <div class="section">
                        <div class="section-title">üìÅ Background</div>
                        <label for="bg-upload" class="file-label">
                            üì§ Upload Background Image
                        </label>
                        <input type="file" id="bg-upload" accept="image/*">
                    </div>

                    <div class="section">
                        <div class="section-title">üìù Add Text</div>
                        <div class="form-group">
                            <label>Text Content</label>
                            <input type="text" id="text-content" placeholder="Enter text or leave blank for placeholder">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Font</label>
                                <select id="text-font">
                                    <option value="Arial">Arial</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times New Roman">Times</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Impact">Impact</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Size</label>
                                <input type="number" id="text-size" value="30" min="8" max="200">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color</label>
                            <input type="color" id="text-color" value="#000000">
                        </div>
                        <button class="btn btn-primary" onclick="addText(false)">
                            ‚ûï Add Normal Text
                        </button>
                        <button class="btn btn-success" onclick="addText(true)" style="margin-top: 8px;">
                            ‚ú® Add as Template Field
                        </button>
                    </div>

                    <div class="section">
                        <div class="section-title">üñºÔ∏è Add Image</div>
                        <label for="img-upload" class="file-label">
                            üì§ Upload Image
                        </label>
                        <input type="file" id="img-upload" accept="image/*">
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="btn btn-primary" onclick="triggerImageUpload(false)" style="flex: 1; font-size: 12px; padding: 10px;">
                                Add Normal
                            </button>
                            <button class="btn btn-success" onclick="triggerImageUpload(true)" style="flex: 1; font-size: 12px; padding: 10px;">
                                Add Template
                            </button>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #856404;">
                                <input type="checkbox" id="img-remove-bg" style="width: 16px; height: 16px;">
                                <span>üé® Remove background (AI, 10-30s)</span>
                            </label>
                        </div>
                        <p style="font-size: 11px; color: #666; margin-top: 10px; padding: 8px; background: #f0f2ff; border-radius: 6px;">
                            üí° <strong>Alternatives:</strong> <a href="https://www.remove.bg" target="_blank" style="color: #667eea;">remove.bg</a> | <a href="https://photoscissors.com" target="_blank" style="color: #667eea;">PhotoScissors</a>
                        </p>
                    </div>

                    <div class="section">
                        <div class="section-title">üéØ Actions</div>
                        <button class="btn btn-secondary" onclick="deleteSelected()">
                            üóëÔ∏è Delete Selected
                        </button>
                        <button class="btn btn-danger" onclick="clearCanvas()">
                            üîÑ Clear All
                        </button>
                    </div>
                </div>

                <div class="canvas-area">
                    <div id="canvas-container">
                        <canvas id="canvas"></canvas>
                    </div>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="downloadSingle()">
                            üíæ Download Current
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bulk Export Tab -->
            <div id="bulk-tab-content" class="tab-content" style="width: 100%; max-width: 1200px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #333; margin-bottom: 10px;">üì¶ Bulk Export Templates</h2>
                    <p style="color: #666;">Fill in data for each template field. Each row creates a new poster.</p>
                </div>

                <div id="bulk-content">
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üìã</div>
                        <p style="font-size: 18px; margin-bottom: 10px;">No template fields yet</p>
                        <p>Go to the Design tab and mark text or images as "template fields"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loading-text">Processing...</p>
    </div>

    <script>
        let canvas;
        let templateFields = [];
        let bulkData = [{}];
        let backgroundImageDimensions = null;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Show selected tab
            if (tabName === 'design') {
                document.querySelector('.tab[onclick*="design"]').classList.add('active');
                document.getElementById('design-tab').classList.add('active');
            } else if (tabName === 'bulk') {
                document.querySelector('.tab[onclick*="bulk"]').classList.add('active');
                document.getElementById('bulk-tab-content').classList.add('active');
                renderBulkExportInterface();
            }
        }

        // Update template count badge
        function updateTemplateCount() {
            document.getElementById('template-count').textContent = templateFields.length;
        }

        // Initialize canvas
        function initCanvas() {
            canvas = new fabric.Canvas('canvas', {
                width: 800,
                height: 600,
                backgroundColor: '#ffffff'
            });

            // Make canvas responsive
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            const containerWidth = container.clientWidth - 4; // Account for border
            const scale = containerWidth / 800;
            
            if (window.innerWidth <= 768) {
                canvas.setDimensions({
                    width: containerWidth,
                    height: containerWidth * 0.75
                });
                canvas.setZoom(scale);
            }
        }

        // Upload background
        document.getElementById('bg-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                fabric.Image.fromURL(event.target.result, function(img) {
                    // Store original dimensions for export
                    backgroundImageDimensions = {
                        width: img.width,
                        height: img.height
                    };

                    // Scale to canvas
                    img.scaleToWidth(canvas.width);
                    img.scaleToHeight(canvas.height);
                    img.selectable = false;
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                });
            };
            reader.readAsDataURL(file);
        });

        // Add text
        function addText(isTemplate) {
            const content = document.getElementById('text-content').value || 'Sample Text';
            const font = document.getElementById('text-font').value;
            const size = parseInt(document.getElementById('text-size').value);
            const color = document.getElementById('text-color').value;

            const text = new fabric.IText(content, {
                left: 100,
                top: 100,
                fontFamily: font,
                fontSize: size,
                fill: color,
                editable: true
            });

            if (isTemplate) {
                const fieldName = prompt('Enter a name for this template field:', content || 'text_' + (templateFields.length + 1));
                if (fieldName) {
                    text.templateField = fieldName;
                    text.templateType = 'text';
                    templateFields.push({
                        name: fieldName,
                        type: 'text',
                        object: text
                    });
                    
                    // Add visual indicator
                    text.set({
                        stroke: '#667eea',
                        strokeWidth: 2
                    });

                    updateTemplateCount();
                }
            }

            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();

            document.getElementById('text-content').value = '';
        }

        // Trigger image upload with template option
        let pendingImageTemplate = false;
        
        function triggerImageUpload(asTemplate) {
            pendingImageTemplate = asTemplate;
            document.getElementById('img-upload').click();
        }

        // Upload and add image
        document.getElementById('img-upload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const isTemplate = pendingImageTemplate;
            const removeBg = document.getElementById('img-remove-bg').checked;
            pendingImageTemplate = false;

            showLoading('Loading image...');

            try {
                let imageUrl;

                if (removeBg && typeof window.removeBackground !== 'undefined') {
                    updateLoadingText('Removing background with AI (this may take 10-30 seconds)...');
                    try {
                        const blob = await window.removeBackground(file);
                        imageUrl = URL.createObjectURL(blob);
                    } catch (bgError) {
                        console.error('Background removal failed:', bgError);
                        alert('Background removal failed. Using original image.\n\nTip: Try smaller images (< 2MB) or use remove.bg');
                        imageUrl = URL.createObjectURL(file);
                    }
                } else if (removeBg) {
                    alert('Background removal library is still loading. Please try again in a few seconds.');
                    hideLoading();
                    e.target.value = '';
                    document.getElementById('img-remove-bg').checked = false;
                    return;
                } else {
                    imageUrl = URL.createObjectURL(file);
                }

                fabric.Image.fromURL(imageUrl, function(img) {
                    img.scaleToWidth(200);
                    img.set({
                        left: 100,
                        top: 100
                    });

                    if (isTemplate) {
                        const fieldName = prompt('Enter a name for this template field:', 'image_' + (templateFields.length + 1));
                        if (fieldName) {
                            img.templateField = fieldName;
                            img.templateType = 'image';
                            templateFields.push({
                                name: fieldName,
                                type: 'image',
                                object: img
                            });
                            
                            // Add visual indicator
                            img.set({
                                stroke: '#667eea',
                                strokeWidth: 3
                            });

                            updateTemplateCount();
                        }
                    }

                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    hideLoading();
                });
            } catch (error) {
                console.error('Error processing image:', error);
                alert('Error processing image: ' + error.message);
                hideLoading();
            }

            document.getElementById('img-remove-bg').checked = false;
            e.target.value = '';
        });

        // Delete selected object
        function deleteSelected() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                // Remove from template fields if it's a template
                if (activeObject.templateField) {
                    templateFields = templateFields.filter(f => f.object !== activeObject);
                    updateTemplateCount();
                }
                canvas.remove(activeObject);
                canvas.renderAll();
            }
        }

        // Clear canvas
        function clearCanvas() {
            if (confirm('Are you sure you want to clear everything?')) {
                canvas.clear();
                canvas.backgroundColor = '#ffffff';
                templateFields = [];
                bulkData = [{}];
                backgroundImageDimensions = null;
                updateTemplateCount();
            }
        }

        // Download single poster
        function downloadSingle() {
            const exportDimensions = backgroundImageDimensions || {
                width: canvas.width,
                height: canvas.height
            };

            // Temporarily remove blue strokes from template fields
            const templateObjects = canvas.getObjects().filter(obj => obj.templateField);
            const originalStrokes = [];
            
            templateObjects.forEach(obj => {
                originalStrokes.push({
                    obj: obj,
                    stroke: obj.stroke,
                    strokeWidth: obj.strokeWidth
                });
                obj.set({ stroke: null, strokeWidth: 0 });
            });
            
            canvas.renderAll();

            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: exportDimensions.width / canvas.width
            });
            
            // Restore blue strokes
            originalStrokes.forEach(item => {
                item.obj.set({ 
                    stroke: item.stroke, 
                    strokeWidth: item.strokeWidth 
                });
            });
            canvas.renderAll();

            const link = document.createElement('a');
            link.download = 'poster_' + Date.now() + '.png';
            link.href = dataURL;
            link.click();
        }

        // Render bulk export interface in tab
        function renderBulkExportInterface() {
            const bulkContent = document.getElementById('bulk-content');

            if (templateFields.length === 0) {
                bulkContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üìã</div>
                        <p style="font-size: 18px; margin-bottom: 10px;">No template fields yet</p>
                        <p>Go to the Design tab and mark text or images as "template fields"</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="bulk-data-section">
                    <h3 style="margin-bottom: 15px; color: #333;">Template Data</h3>
                    <p style="color: #666; margin-bottom: 20px;">Each row will generate one poster. Fill in the data for each template field.</p>
                    
                    <div class="bulk-data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
            `;

            // Add column headers for each template field
            templateFields.forEach(field => {
                tableHTML += `<th>${field.name} (${field.type})</th>`;
            });

            tableHTML += `<th style="width: 80px;">Actions</th></tr></thead><tbody>`;

            // Add rows for data
            bulkData.forEach((data, rowIndex) => {
                tableHTML += `<tr>`;
                tableHTML += `<td><strong>${rowIndex + 1}</strong></td>`;

                templateFields.forEach(field => {
                    if (field.type === 'text') {
                        tableHTML += `
                            <td>
                                <input type="text" 
                                       placeholder="Enter ${field.name}"
                                       value="${data[field.name] || ''}"
                                       onchange="bulkData[${rowIndex}]['${field.name}'] = this.value">
                            </td>
                        `;
                    } else if (field.type === 'image') {
                        const hasImage = data[field.name] ? '‚úì Image' : 'Choose';
                        tableHTML += `
                            <td>
                                <input type="file" 
                                       id="bulk-img-${field.name}-${rowIndex}" 
                                       accept="image/*"
                                       onchange="handleBulkImage('${field.name}', ${rowIndex}, this)">
                                <label for="bulk-img-${field.name}-${rowIndex}" 
                                       style="cursor: pointer; color: #667eea; font-weight: 600;">
                                    ${hasImage}
                                </label>
                            </td>
                        `;
                    }
                });

                tableHTML += `
                    <td>
                        <button onclick="removeDataRow(${rowIndex})" ${bulkData.length <= 1 ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>
                            ‚úï
                        </button>
                    </td>
                </tr>`;
            });

            tableHTML += `</tbody></table></div>`;

            tableHTML += `
                <div class="bulk-actions">
                    <button class="btn btn-primary" onclick="addDataRow()">
                        ‚ûï Add Row
                    </button>
                    <button class="btn btn-success" onclick="generateBulk()">
                        üöÄ Generate & Download All (${bulkData.length} poster${bulkData.length > 1 ? 's' : ''})
                    </button>
                </div>
            </div>`;

            bulkContent.innerHTML = tableHTML;
        }

        function addDataRow() {
            bulkData.push({});
            renderBulkExportInterface();
        }

        function removeDataRow(index) {
            if (bulkData.length <= 1) return;
            bulkData.splice(index, 1);
            renderBulkExportInterface();
        }

        function handleBulkImage(fieldName, index, input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                bulkData[index][fieldName] = e.target.result;
                renderBulkExportInterface();
            };
            reader.readAsDataURL(file);
        }

        async function generateBulk() {
            showLoading('Generating posters...');
            
            const zip = new JSZip();
            const promises = [];

            const exportDimensions = backgroundImageDimensions || {
                width: canvas.width,
                height: canvas.height
            };

            for (let i = 0; i < bulkData.length; i++) {
                const data = bulkData[i];
                updateLoadingText(`Generating poster ${i + 1} of ${bulkData.length}...`);

                const promise = new Promise(async (resolve) => {
                    // Save current state
                    const originalState = canvas.toJSON(['templateField', 'templateType']);

                    // Update template fields with data
                    for (const field of templateFields) {
                        if (field.type === 'text' && data[field.name]) {
                            field.object.set('text', data[field.name]);
                        } else if (field.type === 'image' && data[field.name]) {
                            await new Promise((imgResolve) => {
                                fabric.Image.fromURL(data[field.name], function(img) {
                                    const originalObj = field.object;
                                    img.set({
                                        left: originalObj.left,
                                        top: originalObj.top,
                                        scaleX: originalObj.scaleX,
                                        scaleY: originalObj.scaleY,
                                        angle: originalObj.angle
                                    });
                                    
                                    canvas.remove(originalObj);
                                    canvas.add(img);
                                    field.object = img;
                                    canvas.renderAll();
                                    imgResolve();
                                });
                            });
                        }
                    }

                    canvas.renderAll();

                    // Wait a bit for rendering
                    setTimeout(() => {
                        // Temporarily remove blue strokes from template fields
                        const templateObjects = canvas.getObjects().filter(obj => obj.templateField);
                        const originalStrokes = [];
                        
                        templateObjects.forEach(obj => {
                            originalStrokes.push({
                                obj: obj,
                                stroke: obj.stroke,
                                strokeWidth: obj.strokeWidth
                            });
                            obj.set({ stroke: null, strokeWidth: 0 });
                        });
                        
                        canvas.renderAll();

                        const dataURL = canvas.toDataURL({
                            format: 'png',
                            quality: 1,
                            multiplier: exportDimensions.width / canvas.width
                        });

                        // Restore blue strokes
                        originalStrokes.forEach(item => {
                            item.obj.set({ 
                                stroke: item.stroke, 
                                strokeWidth: item.strokeWidth 
                            });
                        });

                        // Convert to blob
                        fetch(dataURL)
                            .then(res => res.blob())
                            .then(blob => {
                                zip.file(`poster_${i + 1}.png`, blob);
                                
                                // Restore original state
                                canvas.loadFromJSON(originalState, () => {
                                    canvas.renderAll();
                                    // Restore template field references
                                    canvas.getObjects().forEach(obj => {
                                        if (obj.templateField) {
                                            const field = templateFields.find(f => f.name === obj.templateField);
                                            if (field) {
                                                field.object = obj;
                                            }
                                        }
                                    });
                                    resolve();
                                });
                            });
                    }, 100);
                });

                promises.push(promise);
            }

            await Promise.all(promises);

            updateLoadingText('Creating ZIP file...');
            
            zip.generateAsync({type: 'blob'}).then(function(content) {
                saveAs(content, 'posters_' + Date.now() + '.zip');
                hideLoading();
                alert(`Successfully generated ${bulkData.length} posters!`);
            });
        }

        function showLoading(text) {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loading-text').textContent = text;
        }

        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const activeObject = canvas.getActiveObject();
                if (activeObject && !activeObject.isEditing) {
                    deleteSelected();
                }
            }
        });

        // Handle logo errors - hide if not found
        window.addEventListener('load', function() {
            initCanvas();
            
            const logo1 = document.getElementById('logo1');
            const logo2 = document.getElementById('logo2');
            
            logo1.onerror = function() {
                this.classList.add('hidden');
            };
            
            logo2.onerror = function() {
                this.classList.add('hidden');
            };
        });
    </script>
</body>
</html>
